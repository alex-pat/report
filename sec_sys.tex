\section{СИСТЕМНОЕ ПРОЕКТИРОВАНИЕ}
\label{sec:sys}

Изучив теоретические аспекты разработки кода ядра, рассмотрев различные
существующие используемые и неиспользуемые аналоги и выработав список
необходимых для разработки требований, разбиваем систему на компоненты, что
улучшит гибкость системы
Компоненты в виде блоков и их взаимосвязи указаны на чертеже.
В разрабатываемом модуле можно выделить следующие блоки:
\begin{itemize}
\item системный вызов \texttt{sys\_pidmap};
\item системный вызов \texttt{sys\_pidinfo};
\item системный вызов \texttt{sys\_fdmap};
\item системный вызов \texttt{sys\_pidfdopen};
\item системный вызов \texttt{sys\_pidfdinfo};
\item подсистема управления задачами ядра;
\item подсистема виртульаной файловой системыы;
\item процессы пространства пользователя.
\end{itemize}

Структурная схема, которая иллюстрирует все перечисленные блоки и связи
между ними, приведена на чертеже ГУИР.400201.055 C1.

Каждый блок системы выполняет свою определенную задачу и взаимодействует с
другими модулями последством передачи различных бинарных данных. 

Процесс пространства пользователя, чтобы получить нужные данные о процессах,
делает системные вызовы \texttt{sys\_pidmap, sys\_pidinfo}.
При этом он дополнительно может передавать информацию о том, какие именно данные
ему необходимо получить, а какие ему не потребуются.
В это время системные вызовы обращаются к подсистеме управления задачами ядра,
которая позволяет им получить соответствующие данные. Затем полученные данные
системные вызовы упаковывают в буфер пространства пользователя. 

Для получения данных о файловых дескрипторах процессов и открытия их процесс
пространства пользователя исполняет такие системные вызовы как
\texttt{sys\_fdmap}, \texttt{sys\_pidfdinfo} и \texttt{sys\_pidfdopen},
передавая ядру информацию о том, какие данные необходимо получить, а какие ему
не потребуются. Затем системный вызов обращается к подсистеме виртуальной
файловой системы и их для получения необходимых данных и возвращает их процессу
в пространстве пользователя.

\subsection{Системный вызов \texttt{sys\_pidmap}}
\label{sub:sys:sys_pidmap}

Системный вызов \texttt{sys\_pidmap} необходим для получения списка выделенных в
данный момент идентификаторов PID, связанных с процессами и потоками.
Пространству пользователя могут понадобиться различные данные в зависимости от
поставленной задачи, например:
\begin{itemize}
\item получение списка идентификаторов пользовательских процессов;
\item получение списка потоков ядра;
\item получение списка идентификаторов потоков процесса;
\item получение списка всех выполняющихся задач в системе;
\item построение дерева процессов.
\end{itemize}

Передача флагов позволяет при выполнении данных задач использовать только вызов
\texttt{sys\_pidmap}, что позволяет значительно упростить код пользовательских
программ и ускорить получение необходимых идентификаторов.

\subsection{Системный вызов \texttt{sys\_pidinfo}}
\label{sub:sys:sys_pidinfo}

Для получения подробной информации об отдельном процессе или потоке существуют
файлы \texttt{/proc/\$PID/status} для информации о процессе, либо
\texttt{/proc/\$PID/task/\$TID/status} для информации о потоке процесса. Кроме
того, файл \texttt{/proc/self/status} позволяет получить информацию о текущем
процессе, так как \texttt{/proc/self/} является символьной ссылкой на
директорию, описывающую текущий процесс. Получение информации осуществляется
чтением файлов:

\medskip
\begin{lstlisting}[style=cstyle]
# head /proc/self/status
Name:   head
Umask:  0022
State:  R (running)
Tgid:   10035
Ngid:   0
Pid:    10035
PPid:   25072
TracerPid:      0
Uid:    1000    1000    1000    1000
Gid:    100     100     100     100
\end{lstlisting}
\medskip

Такие файлы содержат такую инофрмацию, как имя, umask, состояние, набор
идентификаторов, потраченное время работы процесса, число потоков и детей, а
также различную информацию, относящуюся к статистике потребления виртуальной
памяти и пространствам имен. Системный вызов \texttt{sys\_pidinfo} обеспечивает
такую функциональность.

\subsection{Системный вызов \texttt{sys\_fdmap}}
\label{sub:sys:sys_fdmap}

Системный вызов \texttt{getdents()} позволяет получать список элементов
директории, и в случае задачи получения списка открытых файловых
дескрипторов происходит проход по директории \texttt{/proc/\$PID/fd}. Перед
использованием необходимо открыть директорию вызовом \texttt{open()} и закрыть
после использования вызовом \texttt{close()}. В полученном списке структур
(вызовом заполняется буфер) нельзя переходить сразу к определенному элементу
из-за непостоянного размера структур, а сами идентификаторы расположены в
стороковом виде в поле \texttt{d\_name} структуры \texttt{linux\_dirent}.

Системный вызов \texttt{sys\_fdmap} позволяет получать список всех открытых
дескрипторов без накладных расходов, заполняя переданный пользовательским
процессом буфер дескрипторами в бинарном виде и без лишних полей.

\subsection{Системный вызов \texttt{sys\_pidfdopen}}
\label{sub:sys:sys_pidfdopen}

Каждый файл в \texttt{/proc/\$PID/fd/} представляет собой символьную ссылку на
исходный файл, канал или сокет, и при открытии его позволяет обращаться напрямую
к этому файлу, даже если он уже удален, но еще удерживается от окончательного
уничтожения. Системный вызов \texttt{sys\_pidfdopen} предназначен для открытия
файлов через идентификатор процесса и файловый дескриптор. 

\subsection{Системный вызов \texttt{sys\_pidfdinfo}}
\label{sub:sys:sys_pidfdinfo}

Файлы в директории \texttt{/proc/\$PID/fdinfo/} позволяют получать информацию
об открытых дескрипторах процесса. Вызов
\texttt{sys\_pidfdinfo} используется для получения подобной информации. Он
позволяет получить текущую позицию в файле, флаги, а также имя файла, что ранее
осуществлялось вызовом \texttt{readlink()} на \texttt{/proc/\$PID/fd/\$FD}.
Кроме того, существование вызова решает проблему неопределенности для удаленного
файла, путем введения дополнительного флага в возвращаемой структуре.

\subsection{Процессы пространства пользователя}
\label{sub:sys:sys_pidfdinfo}

Пользовательский процесс~--- это процесс, выполняющийся на уровне
привилегий пользователя, и которому необходимо получать некоторые данные из
ядра, например, с целью мониторинга, сбора информации и статистических данных о
системе: данные об использовании памяти, о загрузке процессоров, о процессах,
пользователях, файлах и файловых системах, об использовании различных ресурсов,
сетевая статистика, информация о состоянии устройств в системе.

Настоящий дипломный проект содержит как реализацию примеров программ,
использующих реализованные возможности ядра, так и с использованием
традиционного интерфейса \texttt{procfs}. Кроме того, реализованы тесты
системных вызовов с использованием инструмента Kselftests, который размещается в
директории \texttt{tools/testing/selftests/} относительно корня исходных текстов
ядра.
